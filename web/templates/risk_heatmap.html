{% extends "base.html" %}

{% block title %}Risk Heat Map - {{ portfolio.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <nav class="text-sm breadcrumbs mb-2">
                <a href="{{ url_for('dashboard') }}" class="text-blue-600 hover:underline">Dashboard</a>
                <span class="mx-2">/</span>
                <a href="{{ url_for('portfolio_detail', portfolio_id=portfolio.id) }}" class="text-blue-600 hover:underline">{{ portfolio.name }}</a>
                <span class="mx-2">/</span>
                <span class="text-gray-600">Risk Heat Map</span>
            </nav>
            <h1 class="text-3xl font-bold text-gray-900">Risk Heat Map Analysis</h1>
            <p class="text-gray-600 mt-1">Multi-dimensional risk visualization and correlation analysis</p>
        </div>
        <button onclick="loadRiskData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Refresh Analysis
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <div class="text-sm text-gray-500">Applications</div>
            <div class="text-2xl font-bold text-gray-900" id="totalApps">-</div>
        </div>
        <div class="bg-red-50 rounded-xl shadow-sm p-5 border border-red-100">
            <div class="text-sm text-red-600">Critical</div>
            <div class="text-2xl font-bold text-red-700" id="criticalCount">-</div>
        </div>
        <div class="bg-orange-50 rounded-xl shadow-sm p-5 border border-orange-100">
            <div class="text-sm text-orange-600">High Risk</div>
            <div class="text-2xl font-bold text-orange-700" id="highCount">-</div>
        </div>
        <div class="bg-yellow-50 rounded-xl shadow-sm p-5 border border-yellow-100">
            <div class="text-sm text-yellow-600">Medium Risk</div>
            <div class="text-2xl font-bold text-yellow-700" id="mediumCount">-</div>
        </div>
        <div class="bg-green-50 rounded-xl shadow-sm p-5 border border-green-100">
            <div class="text-sm text-green-600">Low Risk</div>
            <div class="text-2xl font-bold text-green-700" id="lowCount">-</div>
        </div>
    </div>

    <!-- Alerts -->
    <div id="alertsContainer" class="mb-6 hidden">
        <div class="bg-red-50 border border-red-200 rounded-xl p-4">
            <h3 class="font-semibold text-red-800 mb-2">Active Alerts</h3>
            <div id="alertsList" class="space-y-2"></div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="flex border-b overflow-x-auto">
            <button onclick="showTab('heatmap')" id="tab-heatmap" class="px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap">Heat Maps</button>
            <button onclick="showTab('dimensions')" id="tab-dimensions" class="px-6 py-3 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">Risk Dimensions</button>
            <button onclick="showTab('correlations')" id="tab-correlations" class="px-6 py-3 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">Correlations</button>
            <button onclick="showTab('applications')" id="tab-applications" class="px-6 py-3 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">Applications</button>
        </div>

        <!-- Heat Map Tab -->
        <div id="content-heatmap" class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4">Category vs Vendor</h3>
                    <div id="heatmap1" class="overflow-x-auto"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Category vs Business Unit</h3>
                    <div id="heatmap2" class="overflow-x-auto"></div>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-4">Hotspots</h3>
                <div id="hotspotsList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- Dimensions Tab -->
        <div id="content-dimensions" class="p-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4">Risk by Dimension</h3>
                    <canvas id="dimensionChart" height="300"></canvas>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Dimension Breakdown</h3>
                    <div id="dimensionBreakdown" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- Correlations Tab -->
        <div id="content-correlations" class="p-6 hidden">
            <h3 class="text-lg font-semibold mb-4">Risk Dimension Correlations</h3>
            <div id="correlationsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Applications Tab -->
        <div id="content-applications" class="p-6 hidden">
            <div class="mb-4">
                <input type="text" id="appSearch" onkeyup="filterApps()" placeholder="Search applications..." class="border rounded-lg px-4 py-2 w-full max-w-md">
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Application</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Overall Risk</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Top Risks</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const portfolioId = "{{ portfolio.id }}";
let riskData = null;
let dimensionChart = null;

function showTab(tab) {
    document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        el.classList.add('text-gray-500');
    });
    document.getElementById('content-' + tab).classList.remove('hidden');
    const tabEl = document.getElementById('tab-' + tab);
    tabEl.classList.remove('text-gray-500');
    tabEl.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
}

async function loadRiskData() {
    try {
        const response = await fetch(`/api/risk-heatmap/${portfolioId}`);
        riskData = await response.json();
        renderRiskData(riskData);
    } catch (error) {
        console.error('Error loading risk data:', error);
    }
}

function renderRiskData(data) {
    const summary = data.summary;

    // Summary cards
    document.getElementById('totalApps').textContent = summary.total_applications;
    document.getElementById('criticalCount').textContent = summary.critical_count;
    document.getElementById('highCount').textContent = summary.high_count;
    document.getElementById('mediumCount').textContent = summary.medium_count;
    document.getElementById('lowCount').textContent = summary.low_count;

    // Alerts
    if (data.alerts && data.alerts.length > 0) {
        document.getElementById('alertsContainer').classList.remove('hidden');
        document.getElementById('alertsList').innerHTML = data.alerts.slice(0, 5).map(alert => `
            <div class="p-2 bg-white rounded border border-red-200 flex justify-between items-center">
                <div>
                    <span class="font-medium text-red-800">${alert.title}</span>
                    <span class="text-sm text-red-600 ml-2">${alert.description}</span>
                </div>
                <span class="px-2 py-1 rounded text-xs ${alert.severity === 'critical' ? 'bg-red-600 text-white' : 'bg-orange-500 text-white'}">${alert.severity}</span>
            </div>
        `).join('');
    }

    // Heat maps
    if (data.heat_maps) {
        renderHeatMap('heatmap1', data.heat_maps.category_vs_vendor);
        renderHeatMap('heatmap2', data.heat_maps.category_vs_unit);

        // Hotspots
        const allHotspots = Object.values(data.heat_maps).flatMap(h => h.hotspots || []);
        renderHotspots(allHotspots);
    }

    // Dimensions
    renderDimensionChart(summary.dimension_averages);
    renderDimensionBreakdown(summary.dimension_averages);

    // Correlations
    if (data.correlations) {
        renderCorrelations(data.correlations);
    }

    // Applications
    if (data.application_profiles) {
        renderApplicationsTable(data.application_profiles);
    }
}

function renderHeatMap(containerId, heatMapData) {
    if (!heatMapData) return;

    const container = document.getElementById(containerId);
    const xCats = heatMapData.x_categories;
    const yCats = heatMapData.y_categories;

    let html = '<table class="min-w-full border-collapse"><thead><tr><th class="p-2 border"></th>';
    xCats.forEach(x => { html += `<th class="p-2 border text-xs">${x}</th>`; });
    html += '</tr></thead><tbody>';

    yCats.forEach(y => {
        html += `<tr><td class="p-2 border text-xs font-medium">${y}</td>`;
        xCats.forEach(x => {
            const cell = heatMapData.cells.find(c => c.x_value === x && c.y_value === y);
            const score = cell ? cell.risk_score : 0;
            const color = score >= 80 ? 'bg-red-500 text-white' :
                         score >= 60 ? 'bg-orange-400 text-white' :
                         score >= 40 ? 'bg-yellow-400 text-gray-900' :
                         score >= 20 ? 'bg-green-300 text-gray-900' :
                         'bg-green-100 text-gray-600';
            html += `<td class="p-2 border text-center ${color}" title="${cell ? cell.application_count : 0} apps">${score.toFixed(0)}</td>`;
        });
        html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function renderHotspots(hotspots) {
    const container = document.getElementById('hotspotsList');
    const unique = hotspots.slice(0, 6);

    container.innerHTML = unique.map(h => `
        <div class="p-4 rounded-lg ${h.score >= 80 ? 'bg-red-50 border border-red-200' : 'bg-orange-50 border border-orange-200'}">
            <div class="font-semibold">${h.x} / ${h.y}</div>
            <div class="flex justify-between mt-2">
                <span class="text-sm text-gray-500">${h.apps} applications</span>
                <span class="font-bold ${h.score >= 80 ? 'text-red-600' : 'text-orange-600'}">${h.score.toFixed(0)}%</span>
            </div>
        </div>
    `).join('');
}

function renderDimensionChart(averages) {
    const ctx = document.getElementById('dimensionChart').getContext('2d');
    if (dimensionChart) dimensionChart.destroy();

    const labels = Object.keys(averages).map(k => k.charAt(0).toUpperCase() + k.slice(1));
    const values = Object.values(averages);
    const colors = values.map(v => v >= 60 ? '#EF4444' : v >= 40 ? '#F59E0B' : '#10B981');

    dimensionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ label: 'Average Risk Score', data: values, backgroundColor: colors }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            scales: { x: { beginAtZero: true, max: 100 } }
        }
    });
}

function renderDimensionBreakdown(averages) {
    const container = document.getElementById('dimensionBreakdown');

    container.innerHTML = Object.entries(averages).map(([dim, score]) => `
        <div class="p-3 border rounded-lg">
            <div class="flex justify-between items-center mb-2">
                <span class="font-medium capitalize">${dim}</span>
                <span class="px-2 py-1 rounded text-sm ${score >= 60 ? 'bg-red-100 text-red-700' : score >= 40 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${score.toFixed(0)}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="${score >= 60 ? 'bg-red-500' : score >= 40 ? 'bg-yellow-500' : 'bg-green-500'} h-2 rounded-full" style="width: ${score}%"></div>
            </div>
        </div>
    `).join('');
}

function renderCorrelations(correlations) {
    const container = document.getElementById('correlationsGrid');

    container.innerHTML = correlations.map(c => `
        <div class="p-4 border rounded-lg ${Math.abs(c.correlation) >= 0.7 ? 'bg-blue-50 border-blue-200' : ''}">
            <div class="flex justify-between items-center mb-2">
                <span class="font-medium capitalize">${c.dimension_1} <span class="text-gray-400">vs</span> ${c.dimension_2}</span>
                <span class="px-2 py-1 rounded text-sm ${c.correlation > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${c.correlation.toFixed(2)}</span>
            </div>
            <div class="text-sm text-gray-600">${c.insight}</div>
            <div class="text-xs text-gray-400 mt-1">${c.strength} correlation</div>
        </div>
    `).join('');
}

function renderApplicationsTable(profiles) {
    const tbody = document.getElementById('applicationsTableBody');
    const sorted = [...profiles].sort((a, b) => b.overall_score - a.overall_score);

    tbody.innerHTML = sorted.map(app => {
        const topDims = Object.entries(app.dimensions || {})
            .sort((a, b) => b[1].score - a[1].score)
            .slice(0, 3);

        return `
            <tr class="app-row">
                <td class="px-4 py-3 font-medium">${app.app_name}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-sm ${app.overall_severity === 'critical' ? 'bg-red-100 text-red-700' : app.overall_severity === 'high' ? 'bg-orange-100 text-orange-700' : app.overall_severity === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
                        ${app.overall_score.toFixed(0)}%
                    </span>
                </td>
                <td class="px-4 py-3 text-gray-600">${app.category}</td>
                <td class="px-4 py-3 text-gray-600">${app.vendor}</td>
                <td class="px-4 py-3">
                    <div class="flex gap-1 flex-wrap">
                        ${topDims.map(([dim, data]) => `<span class="text-xs px-2 py-1 bg-gray-100 rounded capitalize">${dim}: ${data.score.toFixed(0)}</span>`).join('')}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterApps() {
    const search = document.getElementById('appSearch').value.toLowerCase();
    document.querySelectorAll('.app-row').forEach(row => {
        const name = row.querySelector('td').textContent.toLowerCase();
        row.style.display = name.includes(search) ? '' : 'none';
    });
}

loadRiskData();
</script>
{% endblock %}
